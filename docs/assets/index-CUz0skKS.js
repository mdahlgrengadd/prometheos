import{r as s,g as z,j as e,R as B}from"./index-B1NPGn4R.js";import{Y as q,O as H,Q as _,x as v,Z as C}from"./MacroContext-CVlmrN9y.js";import{B as K}from"./button-BfepXiZQ.js";import{T as F}from"./textarea-CIPqOdyH.js";import{T as U}from"./textarea-CjihsAV4.js";const $=s.createContext(null),Y=({apiId:r,children:l,message:a,setMessage:t,sendMessage:n,isDisabled:f,isTyping:x,exposeApi:o=!0})=>{const b=s.useMemo(()=>{const{state:c,...j}=q;return j},[]),L={type:"none",description:"",actions:[],path:"",state:{enabled:!1,visible:!1}},{updateState:g}=H(o?r:`hidden-${r}`,o?b:L),p=s.useRef(null),M=s.useRef(a),m=s.useRef(t),d=s.useRef(n);s.useEffect(()=>{M.current=a,m.current=t,d.current=n},[a,t,n]),s.useEffect(()=>{p.current||(p.current={sendMessage:async c=>{const j=(c==null?void 0:c.message)||M.current;return j.trim()&&d.current(j),{success:!0}},setInputText:async c=>!c||typeof c.text!="string"?{success:!1,error:"setInputText requires 'text'"}:(m.current(c.text),{success:!0}),getInputText:async()=>({success:!0,data:{text:M.current}}),clearInput:async()=>(m.current(""),{success:!0})})},[]);const h=s.useRef([]);return s.useEffect(()=>{if(o&&p.current){const c=p.current;return[{action:"sendMessage",handler:c.sendMessage},{action:"setInputText",handler:c.setInputText},{action:"getInputText",handler:c.getInputText},{action:"clearInput",handler:c.clearInput}].forEach(({action:k,handler:N})=>{_(r,k,N),h.current.push({id:r,action:k}),console.log(`[WebLLMChat] Registered ${r}.${k}`)}),()=>{z.emit("api:component:unregistered",r),console.log(`[WebLLMChat] Cleanup: unregistered component ${r}`)}}},[r,o]),s.useEffect(()=>{o&&g({message:a,isDisabled:f,isTyping:x})},[o,a,f,x,g]),e.jsx($.Provider,{value:{message:a,setMessage:t,sendMessage:n,isDisabled:f,isTyping:x},children:l})};function O(){const r=B.useContext($);if(!r)throw new Error("useWebLLMChat must be used within a WebLLMChatProvider");return r}const V=({onSendMessage:r,disabled:l=!1,isTyping:a=!1,apiId:t="webllm-chat-input",useContext:n=!0})=>{const[f,x]=s.useState(""),o=O(),b=()=>{f.trim()&&!l&&(r(f),x(""))},L=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),n?o.sendMessage():b())},g=n?o.message:f,p=n?h=>o.setMessage(h.target.value):h=>x(h.target.value),M=n?()=>o.sendMessage():b,m=n?o.isDisabled:l,d=n?o.isTyping:a;return e.jsxs("div",{className:"p-3 border-t border-border",children:[d&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-2",children:[e.jsx("span",{className:"inline-block mr-1",children:"AI is typing"}),e.jsxs("span",{className:"inline-flex",children:[e.jsx("span",{className:"animate-bounce mx-0.5",children:"."}),e.jsx("span",{className:"animate-bounce mx-0.5 animation-delay-200",children:"."}),e.jsx("span",{className:"animate-bounce mx-0.5 animation-delay-400",children:"."})]})]}),e.jsxs("div",{className:"flex items-end space-x-2",children:[n?e.jsx(U,{className:"flex-1 min-h-[40px] max-h-[120px] p-2 border border-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-background text-foreground",placeholder:"Type a message...",value:g,onChange:p,onKeyDown:L,disabled:m,rows:1,style:{height:"auto",maxHeight:"120px",minHeight:"40px"}}):e.jsx(F,{apiId:t,className:"flex-1 min-h-[40px] max-h-[120px] p-2 border border-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-background text-foreground",placeholder:"Type a message...",value:g,onChange:p,onKeyDown:L,disabled:m,rows:1,style:{height:"auto",maxHeight:"120px",minHeight:"40px"}}),e.jsx(K,{apiId:`${t}-send`,apiName:"Send Message",apiDescription:"Send the current message to the AI assistant",apiPath:"/apps/webllm-chat/input",className:"px-4 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0",onClick:M,disabled:!g.trim()||m,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),e.jsx("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})]})]})},G=({messages:r})=>{const l=s.useRef(null);s.useEffect(()=>{var t;(t=l.current)==null||t.scrollIntoView({behavior:"smooth"})},[r]);const a=r.filter(t=>t.role!=="system");return e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[a.length===0&&e.jsx("div",{className:"flex h-full items-center justify-center text-muted-foreground",children:e.jsx("p",{children:"Start a conversation with the AI assistant"})}),a.map((t,n)=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[80%] p-3 rounded-lg ${t.role==="user"?"bg-blue-100 text-blue-900":"bg-card text-foreground"}`,children:[e.jsx("div",{className:"text-xs font-semibold mb-1 text-left",children:t.role==="user"?"You":"AI Assistant"}),e.jsx("div",{className:"whitespace-pre-wrap text-left",children:t.content||t.role==="assistant"&&e.jsx("span",{className:"animate-pulse",children:"â–‹"})})]})},n)),e.jsx("div",{ref:l})]})},Q=({models:r,selectedModel:l,onSelectModel:a,disabled:t=!1})=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{htmlFor:"model-select",className:"mr-2 text-sm font-medium",children:"Model:"}),e.jsx("select",{id:"model-select",className:"bg-background border border-border text-foreground text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-1.5",value:l,onChange:n=>a(n.target.value),disabled:t,children:r.map(n=>e.jsx("option",{value:n,children:n},n))})]}),P=["Llama-3.1-8B-Instruct-q4f32_1-MLC","Phi-3-mini-4k-instruct-q4f32_1-MLC","Gemma-2B-it-q4f32_1-MLC","Mistral-7B-v0.3-q4f32_1-MLC"],Z=({messages:r,isWorkerReady:l,isLoading:a,isTyping:t,isModelLoaded:n,loadingProgress:f,selectedModel:x,onModelChange:o,onSendMessage:b})=>e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"WebLLM Chat (Web Worker)"}),e.jsx(Q,{models:P,selectedModel:x,onSelectModel:o,disabled:a||t||!l})]}),l?a?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4 mx-auto"}),e.jsx("p",{children:f})]})}):e.jsxs(e.Fragment,{children:[e.jsx(G,{messages:r}),e.jsx(V,{onSendMessage:b,disabled:!n||t||!l,isTyping:t,useContext:!0,apiId:"webllm-chat-input"})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4 mx-auto"}),e.jsx("p",{children:"Initializing WebLLM worker..."})]})})]}),J=()=>{const[r,l]=s.useState([{role:"system",content:"You are a helpful AI assistant."}]),[a,t]=s.useState(P[0]),[n,f]=s.useState(!1),[x,o]=s.useState(""),[b,L]=s.useState(!1),[g,p]=s.useState(!1),[M,m]=s.useState(null),[d,h]=s.useState(!1),[c,j]=s.useState("");s.useEffect(()=>((async()=>{try{if(await v.isPluginRegistered("webllm"))h(!0),console.log("WebLLM worker already registered");else{let w;C.workerEntrypoint?w=`/worker/${C.workerEntrypoint}`:console.error("No workerEntrypoint defined in manifest"),await v.registerPlugin("webllm",w)?(h(!0),console.log("WebLLM worker registered successfully")):console.error("Failed to register WebLLM worker")}}catch(i){console.error("Error initializing WebLLM worker:",i)}})(),()=>{}),[]),s.useEffect(()=>d?(d&&(async()=>{try{f(!0),p(!1),o("Starting model initialization...");const i=setInterval(async()=>{try{const u=await v.getModelProgress();u&&u.text&&o(`Loading model: ${u.text||"Initializing..."} (${Math.round(u.progress*100)}%)`)}catch(u){console.error("Error getting progress:",u)}},200);m(i);const w=await v.loadModel(a);w.status==="success"?p(!0):o(`Error: ${w.message||"Unknown error"}`),f(!1),i&&(clearInterval(i),m(null))}catch(i){console.error("Error initializing model:",i),o(`Error: ${i instanceof Error?i.message:String(i)}`),f(!1),M&&(clearInterval(M),m(null))}})(),()=>{M&&clearInterval(M),d&&v.cleanupWebLLM().catch(i=>{console.error("Error cleaning up WebLLM:",i)})}):void 0,[a,d]);const k=y=>{t(y)},N=s.useCallback(async y=>{if(!y.trim()||!g||!d)return;j("");const i={role:"user",content:y},w=[...r,i];l(w);try{L(!0);const u={role:"assistant",content:""};l([...w,u]);const W=(await v.chat(w,.7)).getReader();let R="";try{for(;;){const{done:E,value:A}=await W.read();if(E)break;R+=A,l(D=>{const I=[...D];return I[I.length-1]={role:"assistant",content:R},I})}}catch(E){console.error("Error reading from stream:",E)}finally{W.releaseLock()}L(!1)}catch(u){console.error("Error generating response:",u);const S={role:"assistant",content:`Error generating response: ${u instanceof Error?u.message:String(u)}`};l([...w,S]),L(!1)}},[r,g,d]),T=s.useCallback(y=>{const i=y||c;i.trim()&&N(i)},[c,N]);return e.jsx(Y,{apiId:"webllm-chat-input",message:c,setMessage:j,sendMessage:T,isDisabled:!g||b||!d,isTyping:b,children:e.jsx(Z,{messages:r,isWorkerReady:d,isLoading:n,isTyping:b,isModelLoaded:g,loadingProgress:x,selectedModel:a,onModelChange:k,onSendMessage:N})},`webllm-chat-context-${d}-${g}`)},ne={id:C.id,manifest:C,init:async()=>{console.log("Worker WebLLM Chat plugin initialized")},render:()=>e.jsx(J,{})};export{ne as default};
