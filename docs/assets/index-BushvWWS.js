import{r as e,j as t}from"./index-CM0htoqd.js";import{u as r,g as n}from"./fileSystem-D8xhFYPC.js";import{y as i}from"./MacroContext-EXPiZfro.js";import"./monaco-editor-Ch9pnC_y.js";const s=({initFromUrl:i})=>{const[s,l]=e.useState(null),[o,a]=e.useState(null),[c,d]=e.useState(!0),p=e.useRef(null);return e.useEffect((()=>{(async()=>{var e,t,s;if(!i)return a("No app data provided"),void d(!1);a(null),d(!0);try{if(i.content&&!i.error)return l(i.content),void d(!1);if(i.error)throw new Error(i.error);const o=i.initFromUrl;if(!o)throw new Error("No URL provided in init data");if(o.startsWith("app://PublishedApps/")){const n=o.substring(20),i=null==(e=r.getState().fs.children)?void 0:e.find((e=>"published-apps"===e.id&&"folder"===e.type));if(!i)throw new Error("Published Apps folder not found");const a=null==(t=i.children)?void 0:t.find((e=>e.name===n&&"folder"===e.type));if(!a)throw new Error(`Published app not found: ${n}`);const c=null==(s=a.children)?void 0:s.find((e=>"index.html"===e.name&&"file"===e.type));if(!c||!c.content)throw new Error(`index.html not found in published app: ${n}`);l(c.content)}else{if(!o.startsWith("vfs://"))throw new Error(`Unsupported URL scheme: ${o}`);{const e=o.substring(6),t=n(e);if(null==t)throw new Error(`Published app not found: ${e}`);l(t)}}}catch(o){a(o instanceof Error?o.message:"Failed to load app")}finally{d(!1)}})()}),[i]),e.useEffect((()=>{var e;if(!s||!p.current)return;const t=p.current.contentDocument;if(!t)return;const n=[];t.open();let l=s;if(s.trim().toLowerCase().startsWith("<!doctype")||s.trim().toLowerCase().startsWith("<html")){if(s.includes('src="./app.js"')||s.includes("src='./app.js'"))try{let t="";if((null==(e=null==i?void 0:i.initFromUrl)?void 0:e.startsWith("app://PublishedApps/"))&&(t=i.initFromUrl.substring(20)),t){const e=(()=>{var e,n,i;try{const s=null==(e=r.getState().fs.children)?void 0:e.find((e=>"published-apps"===e.id&&"folder"===e.type));if(s){const e=null==(n=s.children)?void 0:n.find((e=>e.name===t&&"folder"===e.type));if(e){const t=null==(i=e.children)?void 0:i.find((e=>"app.js"===e.name&&"file"===e.type));return(null==t?void 0:t.content)||""}}}catch(s){}return""})();if(e){const t=new Blob([e],{type:"application/javascript"}),r=URL.createObjectURL(t);n.push(r),l=s.replace(/<script([^>]*)src=["']\.\/app\.js["']([^>]*)>\s*<\/script>/gi,`<script$1src="${r}"$2><\/script>`)}}}catch(o){}}else l=`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset="UTF-8">\n          <meta name="viewport" content="width=device-width, initial-scale=1.0">\n          <title>App Preview</title>\n          <style>\n            body { font-family: sans-serif; margin: 0; padding: 16px; }\n          </style>\n        </head>\n        <body>\n          <div id="app"></div>\n          <script type="text/javascript">\n            try {\n              ${s}\n            } catch (err) {\n              document.body.innerHTML = '<div style="color: red; padding: 20px;"><h3>Runtime Error:</h3><pre>' + err.message + '</pre></div>';\n            }\n          <\/script>\n        </body>\n        </html>\n      `;return p.current.srcdoc=l,()=>{n.forEach((e=>URL.revokeObjectURL(e)))}}),[s,i]),t.jsx("div",{className:"panel-area flex flex-col",style:{height:"100%",minHeight:0,maxHeight:"none"},children:t.jsx("div",{className:"flex flex-col flex-1 relative",children:t.jsxs("div",{className:"relative h-full",children:[t.jsx("iframe",{ref:p,title:"App Preview",className:"w-full h-full border-none bg-white",sandbox:"allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts"}),o&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-50",children:t.jsxs("div",{className:"text-red-600 p-4 text-center",children:[t.jsx("h3",{children:"Load Error"}),t.jsx("pre",{className:"text-sm mt-2 whitespace-pre-wrap",children:o}),i&&t.jsxs("div",{className:"text-sm mt-2",children:["URL:"," ",t.jsx("code",{className:"bg-red-100 px-2 py-1 rounded",children:i.initFromUrl})]})]})}),c&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-50",children:t.jsxs("div",{className:"text-gray-500 text-center",children:[t.jsx("div",{className:"animate-spin text-4xl mb-4",children:"⚙️"}),t.jsx("h3",{className:"text-lg mb-2",children:"Loading App..."}),t.jsx("p",{children:(null==i?void 0:i.initFromUrl)&&t.jsx("code",{className:"bg-gray-100 px-2 py-1 rounded text-xs",children:i.initFromUrl})})]})}),!s&&!o&&!c&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-50",children:t.jsxs("div",{className:"text-gray-500 text-center",children:[t.jsx("h3",{className:"text-lg mb-2",children:"App Preview"}),t.jsx("p",{children:"Open a published app (.exe file) to preview it here"})]})})]})})})};let l;const o={id:i.id,manifest:i,init:async e=>{l=e},render:e=>{const r=e||l;return t.jsx(s,{initFromUrl:r})},onOpen:e=>{e&&(l=e)},onClose:()=>{l=void 0}};export{o as default};
