var X=Object.defineProperty;var B=(y,d,m)=>d in y?X(y,d,{enumerable:!0,configurable:!0,writable:!0,value:m}):y[d]=m;var x=(y,d,m)=>B(y,typeof d!="symbol"?d+"":d,m);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const y=Symbol("Comlink.proxy"),d=Symbol("Comlink.endpoint"),m=Symbol("Comlink.releaseProxy"),$=Symbol("Comlink.finalizer"),E=Symbol("Comlink.thrown"),A=e=>typeof e=="object"&&e!==null||typeof e=="function",L={canHandle:e=>A(e)&&e[y],serialize(e){const{port1:r,port2:t}=new MessageChannel;return R(e,r),[t,[t]]},deserialize(e){return e.start(),V(e)}},N={canHandle:e=>A(e)&&E in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},O=new Map([["proxy",L],["throw",N]]);function F(e,r){for(const t of e)if(r===t||t==="*"||t instanceof RegExp&&t.test(r))return!0;return!1}function R(e,r=globalThis,t=["*"]){r.addEventListener("message",function a(s){if(!s||!s.data)return;if(!F(t,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:n,type:l,path:c}=Object.assign({path:[]},s.data),u=(s.data.argumentList||[]).map(h);let i;try{const o=c.slice(0,-1).reduce((g,p)=>g[p],e),f=c.reduce((g,p)=>g[p],e);switch(l){case"GET":i=f;break;case"SET":o[c.slice(-1)[0]]=h(s.data.value),i=!0;break;case"APPLY":i=f.apply(o,u);break;case"CONSTRUCT":{const g=new f(...u);i=D(g)}break;case"ENDPOINT":{const{port1:g,port2:p}=new MessageChannel;R(e,p),i=W(g,[g])}break;case"RELEASE":i=void 0;break;default:return}}catch(o){i={value:o,[E]:0}}Promise.resolve(i).catch(o=>({value:o,[E]:0})).then(o=>{const[f,g]=k(o);r.postMessage(Object.assign(Object.assign({},f),{id:n}),g),l==="RELEASE"&&(r.removeEventListener("message",a),T(r),$ in e&&typeof e[$]=="function"&&e[$]())}).catch(o=>{const[f,g]=k({value:new TypeError("Unserializable return value"),[E]:0});r.postMessage(Object.assign(Object.assign({},f),{id:n}),g)})}),r.start&&r.start()}function U(e){return e.constructor.name==="MessagePort"}function T(e){U(e)&&e.close()}function V(e,r){const t=new Map;return e.addEventListener("message",function(s){const{data:n}=s;if(!n||!n.id)return;const l=t.get(n.id);if(l)try{l(n)}finally{t.delete(n.id)}}),S(e,t,[],r)}function P(e){if(e)throw new Error("Proxy has been released and is not useable")}function C(e){return w(e,new Map,{type:"RELEASE"}).then(()=>{T(e)})}const b=new WeakMap,M="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const r=(b.get(e)||0)-1;b.set(e,r),r===0&&C(e)});function _(e,r){const t=(b.get(r)||0)+1;b.set(r,t),M&&M.register(e,r,e)}function j(e){M&&M.unregister(e)}function S(e,r,t=[],a=function(){}){let s=!1;const n=new Proxy(a,{get(l,c){if(P(s),c===m)return()=>{j(n),C(e),r.clear(),s=!0};if(c==="then"){if(t.length===0)return{then:()=>n};const u=w(e,r,{type:"GET",path:t.map(i=>i.toString())}).then(h);return u.then.bind(u)}return S(e,r,[...t,c])},set(l,c,u){P(s);const[i,o]=k(u);return w(e,r,{type:"SET",path:[...t,c].map(f=>f.toString()),value:i},o).then(h)},apply(l,c,u){P(s);const i=t[t.length-1];if(i===d)return w(e,r,{type:"ENDPOINT"}).then(h);if(i==="bind")return S(e,r,t.slice(0,-1));const[o,f]=H(u);return w(e,r,{type:"APPLY",path:t.map(g=>g.toString()),argumentList:o},f).then(h)},construct(l,c){P(s);const[u,i]=H(c);return w(e,r,{type:"CONSTRUCT",path:t.map(o=>o.toString()),argumentList:u},i).then(h)}});return _(n,e),n}function v(e){return Array.prototype.concat.apply([],e)}function H(e){const r=e.map(k);return[r.map(t=>t[0]),v(r.map(t=>t[1]))]}const z=new WeakMap;function W(e,r){return z.set(e,r),e}function D(e){return Object.assign(e,{[y]:!0})}function k(e){for(const[r,t]of O)if(t.canHandle(e)){const[a,s]=t.serialize(e);return[{type:"HANDLER",name:r,value:a},s]}return[{type:"RAW",value:e},z.get(e)||[]]}function h(e){switch(e.type){case"HANDLER":return O.get(e.name).deserialize(e.value);case"RAW":return e.value}}function w(e,r,t,a){return new Promise(s=>{const n=G();r.set(n,s),e.start&&e.start(),e.postMessage(Object.assign({id:n},t),a)})}function G(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class Y{constructor(){x(this,"plugins",new Map);x(this,"pluginHandlers",new Map);console.log("Worker Plugin Manager initialized")}async registerPlugin(r,t){try{if(this.plugins.has(r))return{status:"success",message:`Plugin ${r} already registered`};console.log(`Attempting to register plugin: ${r} from ${t}`);let a=t;!a.startsWith("/")&&!a.startsWith("http")&&(a=`/${a}`);const s=new URL(a,self.location.origin).href;console.log(`Resolved import URL: ${s}`);const n=await import(s),l=n.default||n;if(!l||!l.id)return{error:`Invalid plugin module: ${s}`};if(this.plugins.set(r,l),typeof l.handle=="function"){const c=async(u,i)=>{var o;return((o=l.handle)==null?void 0:o.call(l,u,i))??{error:"Handler returned undefined"}};this.pluginHandlers.set(r,c)}else this.pluginHandlers.set(r,async(c,u)=>{const o=l[c];if(typeof o!="function")throw new Error(`Method ${c} not found in plugin ${r}`);return o(...u?Object.values(u):[])});return console.log(`Worker registered plugin: ${r}`),{status:"success",message:`Plugin ${r} registered`}}catch(a){return console.error(`Failed to register plugin ${r}:`,a),{error:`Failed to register plugin ${r}: ${a instanceof Error?a.message:String(a)}`}}}unregisterPlugin(r){return this.plugins.has(r)?(this.plugins.delete(r),this.pluginHandlers.delete(r),console.log(`Worker unregistered plugin: ${r}`),{status:"success"}):{error:`Plugin ${r} not registered`}}isPluginRegistered(r){return this.plugins.has(r)}getPluginInfo(r){const t=this.plugins.get(r);return t?{id:t.id}:null}getAllPlugins(){return Array.from(this.plugins.values()).map(r=>({id:r.id}))}async callPlugin(r,t,a){const s=this.pluginHandlers.get(r);if(!s)return{error:`Plugin ${r} not registered`};try{const n=await s(t,a);return n instanceof ReadableStream?W(n,[n]):n}catch(n){return console.error(`Error calling plugin ${r}.${t}:`,n),{error:`Error in ${r}.${t}: ${n instanceof Error?n.message:String(n)}`}}}}const q=new Y;R(q)})();
