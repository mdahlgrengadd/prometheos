var z=Object.defineProperty;var W=(e,r,t)=>r in e?z(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t;var b=(e,r,t)=>W(e,typeof r!="symbol"?r+"":r,t);/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const $=Symbol("Comlink.proxy"),L=Symbol("Comlink.endpoint"),N=Symbol("Comlink.releaseProxy"),M=Symbol("Comlink.finalizer"),w=Symbol("Comlink.thrown"),x=e=>typeof e=="object"&&e!==null||typeof e=="function",F={canHandle:e=>x(e)&&e[$],serialize(e){const{port1:r,port2:t}=new MessageChannel;return R(e,r),[t,[t]]},deserialize(e){return e.start(),j(e)}},U={canHandle:e=>x(e)&&w in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},A=new Map([["proxy",F],["throw",U]]);function V(e,r){for(const t of e)if(r===t||t==="*"||t instanceof RegExp&&t.test(r))return!0;return!1}function R(e,r=globalThis,t=["*"]){r.addEventListener("message",function l(s){if(!s||!s.data)return;if(!V(t,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:n,type:f,path:a}=Object.assign({path:[]},s.data),u=(s.data.argumentList||[]).map(d);let o;try{const i=a.slice(0,-1).reduce((g,h)=>g[h],e),c=a.reduce((g,h)=>g[h],e);switch(f){case"GET":o=c;break;case"SET":i[a.slice(-1)[0]]=d(s.data.value),o=!0;break;case"APPLY":o=c.apply(i,u);break;case"CONSTRUCT":{const g=new c(...u);o=Y(g)}break;case"ENDPOINT":{const{port1:g,port2:h}=new MessageChannel;R(e,h),o=H(g,[g])}break;case"RELEASE":o=void 0;break;default:return}}catch(i){o={value:i,[w]:0}}Promise.resolve(o).catch(i=>({value:i,[w]:0})).then(i=>{const[c,g]=P(i);r.postMessage(Object.assign(Object.assign({},c),{id:n}),g),f==="RELEASE"&&(r.removeEventListener("message",l),O(r),M in e&&typeof e[M]=="function"&&e[M]())}).catch(i=>{const[c,g]=P({value:new TypeError("Unserializable return value"),[w]:0});r.postMessage(Object.assign(Object.assign({},c),{id:n}),g)})}),r.start&&r.start()}function _(e){return e.constructor.name==="MessagePort"}function O(e){_(e)&&e.close()}function j(e,r){const t=new Map;return e.addEventListener("message",function(s){const{data:n}=s;if(!n||!n.id)return;const f=t.get(n.id);if(f)try{f(n)}finally{t.delete(n.id)}}),k(e,t,[],r)}function m(e){if(e)throw new Error("Proxy has been released and is not useable")}function T(e){return y(e,new Map,{type:"RELEASE"}).then(()=>{O(e)})}const p=new WeakMap,E="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const r=(p.get(e)||0)-1;p.set(e,r),r===0&&T(e)});function v(e,r){const t=(p.get(r)||0)+1;p.set(r,t),E&&E.register(e,r,e)}function D(e){E&&E.unregister(e)}function k(e,r,t=[],l=function(){}){let s=!1;const n=new Proxy(l,{get(f,a){if(m(s),a===N)return()=>{D(n),T(e),r.clear(),s=!0};if(a==="then"){if(t.length===0)return{then:()=>n};const u=y(e,r,{type:"GET",path:t.map(o=>o.toString())}).then(d);return u.then.bind(u)}return k(e,r,[...t,a])},set(f,a,u){m(s);const[o,i]=P(u);return y(e,r,{type:"SET",path:[...t,a].map(c=>c.toString()),value:o},i).then(d)},apply(f,a,u){m(s);const o=t[t.length-1];if(o===L)return y(e,r,{type:"ENDPOINT"}).then(d);if(o==="bind")return k(e,r,t.slice(0,-1));const[i,c]=S(u);return y(e,r,{type:"APPLY",path:t.map(g=>g.toString()),argumentList:i},c).then(d)},construct(f,a){m(s);const[u,o]=S(a);return y(e,r,{type:"CONSTRUCT",path:t.map(i=>i.toString()),argumentList:u},o).then(d)}});return v(n,e),n}function G(e){return Array.prototype.concat.apply([],e)}function S(e){const r=e.map(P);return[r.map(t=>t[0]),G(r.map(t=>t[1]))]}const C=new WeakMap;function H(e,r){return C.set(e,r),e}function Y(e){return Object.assign(e,{[$]:!0})}function P(e){for(const[r,t]of A)if(t.canHandle(e)){const[l,s]=t.serialize(e);return[{type:"HANDLER",name:r,value:l},s]}return[{type:"RAW",value:e},C.get(e)||[]]}function d(e){switch(e.type){case"HANDLER":return A.get(e.name).deserialize(e.value);case"RAW":return e.value}}function y(e,r,t,l){return new Promise(s=>{const n=q();r.set(n,s),e.start&&e.start(),e.postMessage(Object.assign({id:n},t),l)})}function q(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class X{constructor(){b(this,"plugins",new Map);b(this,"pluginHandlers",new Map);console.log("Worker Plugin Manager initialized")}async registerPlugin(r,t){try{if(this.plugins.has(r))return{status:"success",message:`Plugin ${r} already registered`};console.log(`Attempting to register plugin: ${r} from ${t}`);const l="/prometheos/";let s=t;s.startsWith("http")||(s=l+s.replace(/^\//,""));const n=new URL(s,self.location.origin).href;console.log(`Resolved import URL: ${n}`);const f=await import(n),a=f.default||f;if(!a||!a.id)return{error:`Invalid plugin module: ${n}`};if(this.plugins.set(r,a),typeof a.handle=="function"){const u=async(o,i)=>{var c;return((c=a.handle)==null?void 0:c.call(a,o,i))??{error:"Handler returned undefined"}};this.pluginHandlers.set(r,u)}else this.pluginHandlers.set(r,async(u,o)=>{const c=a[u];if(typeof c!="function")throw new Error(`Method ${u} not found in plugin ${r}`);return c(...o?Object.values(o):[])});return console.log(`Worker registered plugin: ${r}`),{status:"success",message:`Plugin ${r} registered`}}catch(l){return console.error(`Failed to register plugin ${r}:`,l),{error:`Failed to register plugin ${r}: ${l instanceof Error?l.message:String(l)}`}}}unregisterPlugin(r){return this.plugins.has(r)?(this.plugins.delete(r),this.pluginHandlers.delete(r),console.log(`Worker unregistered plugin: ${r}`),{status:"success"}):{error:`Plugin ${r} not registered`}}isPluginRegistered(r){return this.plugins.has(r)}getPluginInfo(r){const t=this.plugins.get(r);return t?{id:t.id}:null}getAllPlugins(){return Array.from(this.plugins.values()).map(r=>({id:r.id}))}async callPlugin(r,t,l){const s=this.pluginHandlers.get(r);if(!s)return{error:`Plugin ${r} not registered`};try{const n=await s(t,l);return n instanceof ReadableStream?H(n,[n]):n}catch(n){return console.error(`Error calling plugin ${r}.${t}:`,n),{error:`Error in ${r}.${t}: ${n instanceof Error?n.message:String(n)}`}}}}const B=new X;R(B);
