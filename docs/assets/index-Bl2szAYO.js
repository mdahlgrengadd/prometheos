import{r,g as N,j as e,R as _}from"./index-BeU8qT2o.js";import{a3 as U,$ as V,H as Y,J as h,a4 as E}from"./MacroContext-B0igABmH.js";import{B as J}from"./button-BF0qsmlQ.js";import{T as O}from"./textarea-D9cyJP9l.js";import{T as G}from"./textarea-Dm4Op2dG.js";import"./monaco-editor-Dq6WuQlL.js";const z=r.createContext(null),Q=({apiId:n,children:g,message:i,setMessage:x,sendMessage:s,isDisabled:m,isTyping:M,exposeApi:t=!0})=>{const c=r.useMemo(()=>{const{state:d,...C}=U;return C},[]),L={type:"none",description:"",actions:[],path:"",state:{enabled:!1,visible:!1}},{updateState:p}=V(t?n:`hidden-${n}`,t?c:L),j=r.useRef(null),y=r.useRef(i),v=r.useRef(x),l=r.useRef(s);r.useEffect(()=>{y.current=i,v.current=x,l.current=s},[i,x,s]),r.useEffect(()=>{j.current||(j.current={sendMessage:async d=>{const C=(d==null?void 0:d.message)||y.current;return C.trim()&&l.current(C),{success:!0}},setInputText:async d=>!d||typeof d.text!="string"?{success:!1,error:"setInputText requires 'text'"}:(v.current(d.text),{success:!0}),getInputText:async()=>({success:!0,data:{text:y.current}}),clearInput:async()=>(v.current(""),{success:!0})})},[]);const w=r.useRef([]);return r.useEffect(()=>{if(t&&j.current){const d=j.current;return[{action:"sendMessage",handler:d.sendMessage},{action:"setInputText",handler:d.setInputText},{action:"getInputText",handler:d.getInputText},{action:"clearInput",handler:d.clearInput}].forEach(({action:f,handler:S})=>{Y(n,f,S),w.current.push({id:n,action:f}),console.log(`[WebLLMChat] Registered ${n}.${f}`)}),()=>{N.emit("api:component:unregistered",n),console.log(`[WebLLMChat] Cleanup: unregistered component ${n}`)}}},[n,t]),r.useEffect(()=>{t&&p({message:i,isDisabled:m,isTyping:M})},[t,i,m,M,p]),e.jsx(z.Provider,{value:{message:i,setMessage:x,sendMessage:s,isDisabled:m,isTyping:M},children:g})};function X(){const n=_.useContext(z);if(!n)throw new Error("useWebLLMChat must be used within a WebLLMChatProvider");return n}const Z=({onSendMessage:n,disabled:g=!1,isTyping:i=!1,apiId:x="webllm-chat-input",useContext:s=!0})=>{const[m,M]=r.useState(""),t=X(),c=()=>{m.trim()&&!g&&(n(m),M(""))},L=w=>{w.key==="Enter"&&!w.shiftKey&&(w.preventDefault(),s?t.sendMessage():c())},p=s?t.message:m,j=s?w=>t.setMessage(w.target.value):w=>M(w.target.value),y=s?()=>t.sendMessage():c,v=s?t.isDisabled:g,l=s?t.isTyping:i;return e.jsxs("div",{className:"p-3 border-t border-border",children:[l&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-2",children:[e.jsx("span",{className:"inline-block mr-1",children:"AI is typing"}),e.jsxs("span",{className:"inline-flex",children:[e.jsx("span",{className:"animate-bounce mx-0.5",children:"."}),e.jsx("span",{className:"animate-bounce mx-0.5 animation-delay-200",children:"."}),e.jsx("span",{className:"animate-bounce mx-0.5 animation-delay-400",children:"."})]})]}),e.jsxs("div",{className:"flex items-end space-x-2",children:[s?e.jsx(G,{className:"flex-1 min-h-[40px] max-h-[120px] p-2 border border-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-background text-foreground",placeholder:"Type a message...",value:p,onChange:j,onKeyDown:L,disabled:v,rows:1,style:{height:"auto",maxHeight:"120px",minHeight:"40px"}}):e.jsx(O,{apiId:x,className:"flex-1 min-h-[40px] max-h-[120px] p-2 border border-border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-background text-foreground",placeholder:"Type a message...",value:p,onChange:j,onKeyDown:L,disabled:v,rows:1,style:{height:"auto",maxHeight:"120px",minHeight:"40px"}}),e.jsx(J,{apiId:`${x}-send`,apiName:"Send Message",apiDescription:"Send the current message to the AI assistant",apiPath:"/apps/webllm-chat/input",className:"px-4 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0",onClick:y,disabled:!p.trim()||v,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),e.jsx("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})]})]})},ee=({messages:n})=>{const g=r.useRef(null);r.useEffect(()=>{var s;(s=g.current)==null||s.scrollIntoView({behavior:"smooth"})},[n]);const i=n.filter(s=>s.role!=="system"),x=(s,m)=>{if(s.includes("[Tool Call:")||s.includes("[Executing tool:")||s.includes("[Tool Result]:")||s.includes("[Tool Error]:")||s.includes("[Assistant continues after tool use]")){const M=s.split(/(\[Tool Call:.*?\]|\[Executing tool:.*?\]|\[Tool Result\]:.*?(?=\n\n)|\[Tool Error\]:.*?(?=\n\n)|\[Assistant continues after tool use\])/);return e.jsx(e.Fragment,{children:M.map((t,c)=>t.startsWith("[Tool Call:")?e.jsx("div",{className:"bg-purple-100 p-2 my-1 rounded text-purple-800 font-medium",children:t},c):t.startsWith("[Executing tool:")?e.jsx("div",{className:"bg-blue-100 p-2 my-1 rounded text-blue-800 font-medium",children:t},c):t.startsWith("[Tool Result]:")?e.jsx("div",{className:"bg-green-100 p-2 my-1 rounded text-green-800 font-mono text-sm",children:t},c):t.startsWith("[Tool Error]:")?e.jsx("div",{className:"bg-red-100 p-2 my-1 rounded text-red-800 font-medium",children:t},c):t.startsWith("[Assistant continues after tool use]")?e.jsx("div",{className:"bg-gray-100 p-2 my-1 rounded text-gray-800 font-medium",children:t},c):t.trim()?e.jsx("div",{className:"whitespace-pre-wrap",children:t},c):null)})}return e.jsx("div",{className:"whitespace-pre-wrap",children:s})};return e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[i.length===0&&e.jsx("div",{className:"flex h-full items-center justify-center text-muted-foreground",children:e.jsx("p",{children:"Start a conversation with the AI assistant"})}),i.map((s,m)=>e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[80%] p-3 rounded-lg ${s.role==="user"?"bg-blue-100 text-blue-900":s.role==="tool"?"bg-green-100 text-green-900 font-mono text-sm":"bg-card text-foreground"}`,children:[e.jsx("div",{className:"text-xs font-semibold mb-1 text-left",children:s.role==="user"?"You":s.role==="tool"?`Tool: ${s.name||"Unknown"}`:"AI Assistant"}),e.jsx("div",{className:"text-left",children:s.content?x(s.content,s.role):s.role==="assistant"&&e.jsx("span",{className:"animate-pulse",children:"â–‹"})})]})},m)),e.jsx("div",{ref:g})]})},se=({models:n,selectedModel:g,onSelectModel:i,disabled:x=!1})=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{htmlFor:"model-select",className:"mr-2 text-sm font-medium",children:"Model:"}),e.jsx("select",{id:"model-select",className:"bg-background border border-border text-foreground text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-1.5",value:g,onChange:s=>i(s.target.value),disabled:x,children:n.map(s=>e.jsx("option",{value:s,children:s},s))})]}),A=["Hermes-2-Pro-Llama-3-8B-q4f32_1-MLC","Hermes-2-Pro-Mistral-7B","Llama-3.1-8B-Instruct-q4f32_1-MLC","Phi-3-mini-4k-instruct-q4f32_1-MLC"],re=()=>{const[n,g]=r.useState([{role:"system",content:"You are a helpful AI assistant."}]),[i,x]=r.useState(A[0]),[s,m]=r.useState(!1),[M,t]=r.useState(""),[c,L]=r.useState(!1),[p,j]=r.useState(!1),[y,v]=r.useState(null),[l,w]=r.useState(!1),[d,C]=r.useState(""),[f,S]=r.useState(!0),[R,B]=r.useState([]);r.useEffect(()=>((async()=>{try{if(await h.isPluginRegistered("webllm"))w(!0),console.log("WebLLM worker already registered");else{let b;if(E.workerEntrypoint?b=`/worker/${E.workerEntrypoint}`:console.error("No workerEntrypoint defined in manifest"),await h.registerPlugin("webllm",b)){w(!0),console.log("WebLLM worker registered successfully");try{await h.setupComlinkBridge(),console.log("Comlink bridge established for WebLLM worker")}catch(k){console.error("Failed to setup Comlink bridge:",k)}}else console.error("Failed to register WebLLM worker")}}catch(o){console.error("Error initializing WebLLM worker:",o)}})(),()=>{}),[]),r.useEffect(()=>(N.registerEvent("webllm:answerCompleted"),()=>{N.unregisterEvent("webllm:answerCompleted")}),[]),r.useEffect(()=>{if(!l||!f)return;(async()=>{try{if(await h.isPluginRegistered("mcp-server"))console.log("MCP server already registered"),await h.setupComlinkBridge();else if(await h.registerPlugin("mcp-server","/worker/mcp-server.js"))try{await h.initMCPServer(),await h.setupComlinkBridge(),console.log("MCP server registered, initialized, and bridge established")}catch(k){console.error("Failed to initialize MCP server or establish bridge:",k)}else console.error("Failed to register MCP server worker")}catch(o){console.error("Error initializing MCP server:",o)}})()},[l,f]),r.useEffect(()=>{l&&f&&h.getMCPTools().then(a=>{console.log("Available MCP tools:",a),B(a)}).catch(a=>console.error("Error fetching MCP tools:",a))},[l,f]),r.useEffect(()=>l?(l&&(async()=>{try{m(!0),j(!1),t("Starting model initialization...");const o=setInterval(async()=>{try{const u=await h.getModelProgress();u&&u.text&&t(`Loading model: ${u.text||"Initializing..."} (${Math.round(u.progress*100)}%)`)}catch(u){console.error("Error getting progress:",u)}},200);v(o);const b=await h.loadModel(i);b.status==="success"?j(!0):t(`Error: ${b.message||"Unknown error"}`),m(!1),o&&(clearInterval(o),v(null))}catch(o){console.error("Error initializing model:",o),t(`Error: ${o instanceof Error?o.message:String(o)}`),m(!1),y&&(clearInterval(y),v(null))}})(),()=>{y&&clearInterval(y),l&&h.cleanupWebLLM().catch(o=>{console.error("Error cleaning up WebLLM:",o)})}):void 0,[i,l]);const D=a=>{x(a)},H=()=>{S(!f)},T=r.useCallback(async a=>{if(!a.trim()||!p||!l)return;C("");const o={role:"user",content:a},b=[...n,o];g(b);try{L(!0),console.log("handleSendMessage: toolsEnabled =",f,"messages =",b);const u={role:"assistant",content:""};g([...b,u]);const $=(f?await h.chatWithTools(b,.7):await h.chat(b,.7)).getReader();let W="";try{for(;;){const{done:P,value:q}=await $.read();if(P)break;W+=q,g(K=>{const I=[...K];return I[I.length-1]={role:"assistant",content:W},I})}}catch(P){console.error("Error reading from stream:",P)}finally{$.releaseLock()}L(!1),N.emit("webllm:answerCompleted",{answer:W})}catch(u){console.error("Error generating response:",u);const k={role:"assistant",content:`Error generating response: ${u instanceof Error?u.message:String(u)}`};g([...b,k]),L(!1)}},[n,p,l,f]),F=r.useCallback(a=>{const o=a||d;o.trim()&&T(o)},[d,T]);return e.jsx(Q,{apiId:"webllm-chat-input",message:d,setMessage:C,sendMessage:F,isDisabled:!p||c||!l,isTyping:c,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"WebLLM Chat (Web Worker)"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"mr-2 text-sm",children:"Tools:"}),e.jsx("button",{onClick:H,className:`relative inline-flex items-center h-6 rounded-full w-11 ${f?"bg-blue-600":"bg-gray-200"}`,children:e.jsx("span",{className:`inline-block w-4 h-4 transform transition-transform bg-white rounded-full ${f?"translate-x-6":"translate-x-1"}`})})]}),e.jsx(se,{models:A,selectedModel:i,onSelectModel:D,disabled:s||c||!l})]})]}),e.jsxs("div",{className:"p-2 bg-gray-100 text-xs text-gray-700",children:[e.jsx("div",{className:"font-semibold",children:"Debug: Available Tools"}),R.length>0?e.jsx("ul",{children:R.map(a=>e.jsxs("li",{children:[e.jsx("strong",{children:a.name}),": ",a.description]},a.name))}):e.jsx("div",{children:"No tools loaded yet."})]}),l?s?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4 mx-auto"}),e.jsx("p",{children:M})]})}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{messages:n}),e.jsx(Z,{onSendMessage:T,disabled:!p||c||!l,isTyping:c,useContext:!0,apiId:"webllm-chat-input"})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4 mx-auto"}),e.jsx("p",{children:"Initializing WebLLM worker..."})]})})]})},`webllm-chat-context-${l}-${p}`)},ce={id:E.id,manifest:E,init:async()=>{console.log("Worker WebLLM Chat plugin initialized")},render:()=>e.jsx(re,{})};export{ce as default};
