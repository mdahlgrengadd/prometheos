var e=Object.defineProperty,t=(t,s,r)=>((t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r)(t,"symbol"!=typeof s?s+"":s,r);import{r as s,j as r}from"./index-CM0htoqd.js";import{ai as o}from"./MacroContext-EXPiZfro.js";import"./monaco-editor-Ch9pnC_y.js";let n=(e=21)=>{let t="",s=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&s[e]];return t};!globalThis.EventTarget||globalThis.Event;var i,a=class extends Event{constructor(e,s){super("error",s),t(this,"message"),t(this,"error"),this.message=e.message,this.error=e}},c=class extends Event{constructor(e=1e3,s="",r){super("close",r),t(this,"code"),t(this,"reason"),t(this,"wasClean",!0),this.code=e,this.reason=s}},l=(Event,a),h=c;var u="undefined"!=typeof process&&void 0!==(null==(i=process.versions)?void 0:i.node)&&"undefined"==typeof document?function(e){if("data"in e){return new MessageEvent(e.type,e)}if("code"in e||"reason"in e){return new c(e.code||1999,e.reason||"unknown reason",e)}if("error"in e){return new a(e.error,e)}return new Event(e.type,e)}:function(e){return new e.constructor(e.type,e)},d={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:Number.POSITIVE_INFINITY,maxEnqueuedMessages:Number.POSITIVE_INFINITY},m=!1,p=class e extends EventTarget{constructor(e,s,r={}){super(),t(this,"_ws"),t(this,"_retryCount",-1),t(this,"_uptimeTimeout"),t(this,"_connectTimeout"),t(this,"_shouldReconnect",!0),t(this,"_connectLock",!1),t(this,"_binaryType","blob"),t(this,"_closeCalled",!1),t(this,"_messageQueue",[]),t(this,"_debugLogger"),t(this,"_url"),t(this,"_protocols"),t(this,"_options"),t(this,"onclose",null),t(this,"onerror",null),t(this,"onmessage",null),t(this,"onopen",null),t(this,"_handleOpen",(e=>{this._debug("open event");const{minUptime:t=d.minUptime}=this._options;clearTimeout(this._connectTimeout),this._uptimeTimeout=setTimeout((()=>this._acceptOpen()),t),function(e,t){if(!e)throw new Error(t)}(this._ws,"WebSocket is not defined"),this._ws.binaryType=this._binaryType,this._messageQueue.forEach((e=>{var t;return null==(t=this._ws)?void 0:t.send(e)})),this._messageQueue=[],this.onopen&&this.onopen(e),this.dispatchEvent(u(e))})),t(this,"_handleMessage",(e=>{this._debug("message event"),this.onmessage&&this.onmessage(e),this.dispatchEvent(u(e))})),t(this,"_handleError",(e=>{this._debug("error event",e.message),this._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),this.onerror&&this.onerror(e),this._debug("exec error listeners"),this.dispatchEvent(u(e)),this._connect()})),t(this,"_handleClose",(e=>{this._debug("close event"),this._clearTimeouts(),this._shouldReconnect&&this._connect(),this.onclose&&this.onclose(e),this.dispatchEvent(u(e))})),this._url=e,this._protocols=s,this._options=r,this._options.startClosed&&(this._shouldReconnect=!1),this._options.debugLogger&&(this._debugLogger=this._options.debugLogger),this._connect()}static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}get CONNECTING(){return e.CONNECTING}get OPEN(){return e.OPEN}get CLOSING(){return e.CLOSING}get CLOSED(){return e.CLOSED}get binaryType(){return this._ws?this._ws.binaryType:this._binaryType}set binaryType(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)}get retryCount(){return Math.max(this._retryCount,0)}get bufferedAmount(){return this._messageQueue.reduce(((e,t)=>("string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e)),0)+(this._ws?this._ws.bufferedAmount:0)}get extensions(){return this._ws?this._ws.extensions:""}get protocol(){return this._ws?this._ws.protocol:""}get readyState(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING}get url(){return this._ws?this._ws.url:""}get shouldReconnect(){return this._shouldReconnect}close(e=1e3,t){this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")}reconnect(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()}send(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{const{maxEnqueuedMessages:t=d.maxEnqueuedMessages}=this._options;this._messageQueue.length<t&&(this._debug("enqueue",e),this._messageQueue.push(e))}}_debug(...e){this._options.debug&&this._debugLogger("RWS>",...e)}_getNextDelay(){const{reconnectionDelayGrowFactor:e=d.reconnectionDelayGrowFactor,minReconnectionDelay:t=d.minReconnectionDelay,maxReconnectionDelay:s=d.maxReconnectionDelay}=this._options;let r=0;return this._retryCount>0&&(r=t*e**(this._retryCount-1),r>s&&(r=s)),this._debug("next delay",r),r}_wait(){return new Promise((e=>{setTimeout(e,this._getNextDelay())}))}_getNextProtocols(e){if(!e)return Promise.resolve(null);if("string"==typeof e||Array.isArray(e))return Promise.resolve(e);if("function"==typeof e){const t=e();if(!t)return Promise.resolve(null);if("string"==typeof t||Array.isArray(t))return Promise.resolve(t);if(t.then)return t}throw Error("Invalid protocols")}_getNextUrl(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){const t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")}_connect(){if(this._connectLock||!this._shouldReconnect)return;this._connectLock=!0;const{maxRetries:e=d.maxRetries,connectionTimeout:t=d.connectionTimeout}=this._options;this._retryCount>=e?this._debug("max retries reached",this._retryCount,">=",e):(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),this._wait().then((()=>Promise.all([this._getNextUrl(this._url),this._getNextProtocols(this._protocols||null)]))).then((([e,s])=>{if(this._closeCalled)return void(this._connectLock=!1);this._options.WebSocket||"undefined"!=typeof WebSocket||m||(m=!0);const r=this._options.WebSocket||WebSocket;this._debug("connect",{url:e,protocols:s}),this._ws=s?new r(e,s):new r(e),this._ws.binaryType=this._binaryType,this._connectLock=!1,this._addListeners(),this._connectTimeout=setTimeout((()=>this._handleTimeout()),t)})).catch((e=>{this._connectLock=!1,this._handleError(new l(Error(e.message),this))})))}_handleTimeout(){this._debug("timeout event"),this._handleError(new l(Error("TIMEOUT"),this))}_disconnect(e=1e3,t){if(this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.readyState===this.OPEN&&this._ws.close(e,t),this._handleClose(new h(e,t,this))}catch(s){}}}_acceptOpen(){this._debug("accept open"),this._retryCount=0}_removeListeners(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))}_addListeners(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))}_clearTimeouts(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)}},_=e=>null!==e[1]&&void 0!==e[1];function g(e,t,s={}){const{host:r,path:o,protocol:n,room:i,party:a,basePath:c,prefix:l,query:h}=e;let u=r.replace(/^(http|https|ws|wss):\/\//,"");if(u.endsWith("/")&&(u=u.slice(0,-1)),null==o?void 0:o.startsWith("/"))throw new Error("path must not start with a slash");const d=a??"main",m=o?`/${o}`:"",p=n||(u.startsWith("localhost:")||u.startsWith("127.0.0.1:")||u.startsWith("192.168.")||u.startsWith("10.")||u.startsWith("172.")&&u.split(".")[1]>="16"&&u.split(".")[1]<="31"||u.startsWith("[::ffff:7f00:1]:")?t:`${t}s`),g=`${p}://${u}/${c||`${l||"parties"}/${d}/${i}`}${m}`,y=(e={})=>`${g}?${new URLSearchParams([...Object.entries(s),...Object.entries(e).filter(_)])}`,f="function"==typeof h?async()=>y(await h()):y(h);return{host:u,path:m,room:i,name:d,protocol:p,partyUrl:g,urlProvider:f}}var y=class extends p{constructor(e){const s=f(e);super(s.urlProvider,s.protocols,s.socketOptions),t(this,"_pk"),t(this,"_pkurl"),t(this,"name"),t(this,"room"),t(this,"host"),t(this,"path"),this.partySocketOptions=e,this.setWSProperties(s)}updateProperties(e){const t=f({...this.partySocketOptions,...e,host:e.host??this.host,room:e.room??this.room,path:e.path??this.path});this._url=t.urlProvider,this._protocols=t.protocols,this._options=t.socketOptions,this.setWSProperties(t)}setWSProperties(e){const{_pk:t,_pkurl:s,name:r,room:o,host:n,path:i}=e;this._pk=t,this._pkurl=s,this.name=r,this.room=o,this.host=n,this.path=i}reconnect(e,t){if(!this.room||!this.host)throw new Error("The room and host must be set before connecting, use `updateProperties` method to set them or pass them to the constructor.");super.reconnect(e,t)}get id(){return this._pk}get roomUrl(){return this._pkurl}static async fetch(e,t){const s=g(e,"http"),r="string"==typeof s.urlProvider?s.urlProvider:await s.urlProvider();return(e.fetch??fetch)(r,t)}};function f(e){const{id:t,host:s,path:r,party:o,room:n,protocol:i,query:a,protocols:c,...l}=e,h=t||function(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();let e=(new Date).getTime(),t="undefined"!=typeof performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(s){let r=16*Math.random();return e>0?(r=(e+r)%16|0,e=Math.floor(e/16)):(r=(t+r)%16|0,t=Math.floor(t/16)),("x"===s?r:3&r|8).toString(16)}))}(),u=g(e,"ws",{_pk:h});return{_pk:h,_pkurl:u.partyUrl,name:u.name,room:u.room,host:u.host,path:u.path,protocols:c,socketOptions:l,urlProvider:u.urlProvider}}var x=e=>[e.startClosed,e.minUptime,e.maxRetries,e.connectionTimeout,e.maxEnqueuedMessages,e.maxReconnectionDelay,e.minReconnectionDelay,e.reconnectionDelayGrowFactor,e.debug];function v(e){const{host:t,...r}=e,o=function({options:e,createSocket:t,createSocketMemoKey:r}){const o=r(e),n=s.useMemo((()=>e),[o]),[i,a]=s.useState((()=>t({...n,startClosed:!0}))),c=s.useRef(null),l=s.useRef(t);return l.current=t,s.useEffect((()=>{if(c.current!==i)return c.current||!0===n.startClosed||i.reconnect(),c.current=i,()=>{i.close()};{const e=l.current({...n,startClosed:!1});a(e)}}),[i,n]),i}({options:{host:t||("undefined"!=typeof window?window.location.host:"dummy-domain.com"),...r},createSocket:e=>new y(e),createSocketMemoKey:e=>JSON.stringify([e.query,e.id,e.host,e.room,e.party,e.path,e.protocol,e.protocols,e.basePath,e.prefix,...x(e)])});return((e,t)=>{const r=s.useRef(t);r.current=t,s.useEffect((()=>{const t=e=>{var t,s;return null==(s=null==(t=r.current)?void 0:t.onOpen)?void 0:s.call(t,e)},s=e=>{var t,s;return null==(s=null==(t=r.current)?void 0:t.onMessage)?void 0:s.call(t,e)},o=e=>{var t,s;return null==(s=null==(t=r.current)?void 0:t.onClose)?void 0:s.call(t,e)},n=e=>{var t,s;return null==(s=null==(t=r.current)?void 0:t.onError)?void 0:s.call(t,e)};return e.addEventListener("open",t),e.addEventListener("close",o),e.addEventListener("error",n),e.addEventListener("message",s),()=>{e.removeEventListener("open",t),e.removeEventListener("close",o),e.removeEventListener("error",n),e.removeEventListener("message",s)}}),[e])})(o,e),o}const b=["Alice","Bob","Charlie","David","Eve","Frank","Grace","Heidi","Ivan","Judy","Kevin","Linda","Mallory","Nancy","Oscar","Peggy","Quentin","Randy","Steve","Trent","Ursula","Victor","Walter","Xavier","Yvonne","Zoe"],w=({roomId:e})=>{const[t,o]=s.useState(e),[i,a]=s.useState(null),[c,l]=s.useState(""),[h]=s.useState((()=>b[Math.floor(Math.random()*b.length)])),[u,d]=s.useState([]),[m,p]=s.useState(null),[_,g]=s.useState(""),[y,f]=s.useState(!1),[x,w]=s.useState(3600),[E,N]=s.useState(!1),[C,S]=s.useState("");s.useEffect((()=>{d([]),g(""),f(!1),N(!1),S("")}),[t]);const T=v({party:"chat",room:t,host:"https://cloudflare-chat.mdahlgrengadd.workers.dev",onMessage:e=>{const t=JSON.parse(e.data);if(t.error)return void S(t.error);if(t.ok)return void(t.verified?(f(!0),S("")):(N(!0),f(!0),S("")));const s=t;"add"===s.type?d((e=>[...e,{id:s.id,content:s.content,user:s.user,role:s.role}])):"all"===s.type&&d(s.messages)}});if(!y)return r.jsx("div",{className:"h-full flex flex-col items-center justify-center",children:r.jsxs("div",{className:"p-4 border rounded bg-white max-w-sm w-full",children:[r.jsx("h3",{className:"mb-2 font-bold",children:"Start Chat"}),C&&r.jsx("div",{className:"text-red-500 mb-2",children:C}),!i&&r.jsx(r.Fragment,{children:r.jsxs("div",{className:"mb-2",children:[r.jsx("label",{className:"block mb-1",children:"Room Name/ID"}),r.jsx("input",{className:"w-full p-1 border mb-2",value:c,onChange:e=>l(e.target.value),placeholder:"Enter a room name or ID"}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx("button",{className:"flex-1 bg-blue-500 text-white py-1 rounded",onClick:()=>{c.trim()?(o(c.trim()),a("join"),S("")):S("Room name/ID required")},children:"Join Room"}),r.jsx("button",{className:"flex-1 bg-green-500 text-white py-1 rounded",onClick:()=>{c.trim()?(o(c.trim()),a("create"),S("")):S("Room name/ID required")},children:"Create Room"})]}),r.jsx("button",{className:"mt-2 w-full bg-gray-200 text-gray-700 py-1 rounded",onClick:()=>{const e=n(8);l(e)},children:"Generate Random Room"})]})}),!!i&&r.jsxs("form",{onSubmit:e=>{e.preventDefault(),"create"===i?_.length<3?S("Password must be at least 3 characters long"):T.send(JSON.stringify({type:"create-room",password:_,ttl:x})):_?T.send(JSON.stringify({type:"verify-password",password:_})):S("Password is required")},children:[r.jsx("div",{className:"mb-2",children:r.jsxs("label",{className:"block mb-1",children:["Room: ",r.jsx("span",{className:"font-mono",children:t})]})}),r.jsx("label",{className:"block mb-1",children:"Password"}),r.jsx("input",{type:"password",className:"w-full p-1 border mb-2",value:_,onChange:e=>g(e.target.value),required:!0}),"create"===i&&r.jsxs(r.Fragment,{children:[r.jsx("label",{className:"block mb-1",children:"Room Expiration (seconds)"}),r.jsxs("select",{className:"w-full p-1 border mb-2",value:x,onChange:e=>w(Number(e.target.value)),children:[r.jsx("option",{value:3600,children:"1 hour"}),r.jsx("option",{value:7200,children:"2 hours"}),r.jsx("option",{value:14400,children:"4 hours"}),r.jsx("option",{value:28800,children:"8 hours"}),r.jsx("option",{value:86400,children:"24 hours"})]})]}),r.jsx("button",{type:"submit",className:"w-full bg-blue-500 text-white py-1 rounded",children:"create"===i?"Create Room":"Join Room"}),r.jsx("button",{type:"button",className:"w-full mt-2 bg-gray-300 text-gray-700 py-1 rounded",onClick:()=>{a(null),g(""),S("")},children:"Back"})]})]})});return r.jsxs("div",{className:"h-full flex flex-col",children:[r.jsx("div",{className:"p-2 border-b",children:r.jsxs("div",{className:"flex items-center mb-2",children:[r.jsx("div",{className:"text-sm text-gray-500 flex-1 flex items-center",children:r.jsxs("span",{className:"truncate",children:["Current room: ",t]})}),r.jsx("button",{onClick:()=>{const e=n(8);o(e)},className:"ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600",children:"Random Room"})]})}),r.jsx("div",{className:"flex-1 overflow-auto",children:u.map((e=>r.jsxs("div",{className:"p-2 border-b flex justify-between items-start",children:[r.jsxs("div",{className:"flex-1 break-all",children:[r.jsxs("strong",{children:[e.user,":"]})," ",e.content]}),r.jsx("button",{onClick:()=>{return t=e.id,s=e.content,void navigator.clipboard.writeText(s).then((()=>{p(t),setTimeout((()=>p(null)),2e3)})).catch((e=>{}));var t,s},className:"ml-2 px-2 py-1 bg-gray-200 text-xs rounded hover:bg-gray-300",children:m===e.id?"Copied!":"Copy"})]},e.id)))}),r.jsx("form",{className:"p-2",onSubmit:e=>{e.preventDefault();(e=>{const t={id:n(8),user:h,role:"user",content:e};T.send(JSON.stringify({type:"add",password:_,...t}))})(e.currentTarget.elements.namedItem("content").value),e.currentTarget.reset()},children:r.jsx("input",{name:"content",className:"w-full p-1 border",placeholder:`Hello ${h}!`})})]})},E="chat-last-room-id",N=()=>{const[e,t]=s.useState((()=>{try{return localStorage.getItem(E)||n()}catch(e){return n()}}));return s.useEffect((()=>{try{localStorage.setItem(E,e)}catch(t){}}),[e]),r.jsx(w,{roomId:e})},C={id:o.id,manifest:o,init:async()=>{},render:()=>r.jsx(N,{})};export{C as default};
