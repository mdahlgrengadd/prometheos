var X=Object.defineProperty;var B=(y,d,m)=>d in y?X(y,d,{enumerable:!0,configurable:!0,writable:!0,value:m}):y[d]=m;var x=(y,d,m)=>B(y,typeof d!="symbol"?d+"":d,m);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const y=Symbol("Comlink.proxy"),d=Symbol("Comlink.endpoint"),m=Symbol("Comlink.releaseProxy"),R=Symbol("Comlink.finalizer"),E=Symbol("Comlink.thrown"),A=e=>typeof e=="object"&&e!==null||typeof e=="function",L={canHandle:e=>A(e)&&e[y],serialize(e){const{port1:r,port2:t}=new MessageChannel;return S(e,r),[t,[t]]},deserialize(e){return e.start(),V(e)}},N={canHandle:e=>A(e)&&E in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},O=new Map([["proxy",L],["throw",N]]);function F(e,r){for(const t of e)if(r===t||t==="*"||t instanceof RegExp&&t.test(r))return!0;return!1}function S(e,r=globalThis,t=["*"]){r.addEventListener("message",function l(s){if(!s||!s.data)return;if(!F(t,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:n,type:f,path:a}=Object.assign({path:[]},s.data),u=(s.data.argumentList||[]).map(h);let o;try{const i=a.slice(0,-1).reduce((g,p)=>g[p],e),c=a.reduce((g,p)=>g[p],e);switch(f){case"GET":o=c;break;case"SET":i[a.slice(-1)[0]]=h(s.data.value),o=!0;break;case"APPLY":o=c.apply(i,u);break;case"CONSTRUCT":{const g=new c(...u);o=D(g)}break;case"ENDPOINT":{const{port1:g,port2:p}=new MessageChannel;S(e,p),o=W(g,[g])}break;case"RELEASE":o=void 0;break;default:return}}catch(i){o={value:i,[E]:0}}Promise.resolve(o).catch(i=>({value:i,[E]:0})).then(i=>{const[c,g]=k(i);r.postMessage(Object.assign(Object.assign({},c),{id:n}),g),f==="RELEASE"&&(r.removeEventListener("message",l),T(r),R in e&&typeof e[R]=="function"&&e[R]())}).catch(i=>{const[c,g]=k({value:new TypeError("Unserializable return value"),[E]:0});r.postMessage(Object.assign(Object.assign({},c),{id:n}),g)})}),r.start&&r.start()}function U(e){return e.constructor.name==="MessagePort"}function T(e){U(e)&&e.close()}function V(e,r){const t=new Map;return e.addEventListener("message",function(s){const{data:n}=s;if(!n||!n.id)return;const f=t.get(n.id);if(f)try{f(n)}finally{t.delete(n.id)}}),$(e,t,[],r)}function P(e){if(e)throw new Error("Proxy has been released and is not useable")}function C(e){return w(e,new Map,{type:"RELEASE"}).then(()=>{T(e)})}const b=new WeakMap,M="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const r=(b.get(e)||0)-1;b.set(e,r),r===0&&C(e)});function _(e,r){const t=(b.get(r)||0)+1;b.set(r,t),M&&M.register(e,r,e)}function j(e){M&&M.unregister(e)}function $(e,r,t=[],l=function(){}){let s=!1;const n=new Proxy(l,{get(f,a){if(P(s),a===m)return()=>{j(n),C(e),r.clear(),s=!0};if(a==="then"){if(t.length===0)return{then:()=>n};const u=w(e,r,{type:"GET",path:t.map(o=>o.toString())}).then(h);return u.then.bind(u)}return $(e,r,[...t,a])},set(f,a,u){P(s);const[o,i]=k(u);return w(e,r,{type:"SET",path:[...t,a].map(c=>c.toString()),value:o},i).then(h)},apply(f,a,u){P(s);const o=t[t.length-1];if(o===d)return w(e,r,{type:"ENDPOINT"}).then(h);if(o==="bind")return $(e,r,t.slice(0,-1));const[i,c]=H(u);return w(e,r,{type:"APPLY",path:t.map(g=>g.toString()),argumentList:i},c).then(h)},construct(f,a){P(s);const[u,o]=H(a);return w(e,r,{type:"CONSTRUCT",path:t.map(i=>i.toString()),argumentList:u},o).then(h)}});return _(n,e),n}function v(e){return Array.prototype.concat.apply([],e)}function H(e){const r=e.map(k);return[r.map(t=>t[0]),v(r.map(t=>t[1]))]}const z=new WeakMap;function W(e,r){return z.set(e,r),e}function D(e){return Object.assign(e,{[y]:!0})}function k(e){for(const[r,t]of O)if(t.canHandle(e)){const[l,s]=t.serialize(e);return[{type:"HANDLER",name:r,value:l},s]}return[{type:"RAW",value:e},z.get(e)||[]]}function h(e){switch(e.type){case"HANDLER":return O.get(e.name).deserialize(e.value);case"RAW":return e.value}}function w(e,r,t,l){return new Promise(s=>{const n=G();r.set(n,s),e.start&&e.start(),e.postMessage(Object.assign({id:n},t),l)})}function G(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class Y{constructor(){x(this,"plugins",new Map);x(this,"pluginHandlers",new Map);console.log("Worker Plugin Manager initialized")}async registerPlugin(r,t){try{if(this.plugins.has(r))return{status:"success",message:`Plugin ${r} already registered`};console.log(`Attempting to register plugin: ${r} from ${t}`);const l="/prometheos/";let s=t;s.startsWith("http")||(s=l+s.replace(/^\//,""));const n=new URL(s,self.location.origin).href;console.log(`Resolved import URL: ${n}`);const f=await import(n),a=f.default||f;if(!a||!a.id)return{error:`Invalid plugin module: ${n}`};if(this.plugins.set(r,a),typeof a.handle=="function"){const u=async(o,i)=>{var c;return((c=a.handle)==null?void 0:c.call(a,o,i))??{error:"Handler returned undefined"}};this.pluginHandlers.set(r,u)}else this.pluginHandlers.set(r,async(u,o)=>{const c=a[u];if(typeof c!="function")throw new Error(`Method ${u} not found in plugin ${r}`);return c(...o?Object.values(o):[])});return console.log(`Worker registered plugin: ${r}`),{status:"success",message:`Plugin ${r} registered`}}catch(l){return console.error(`Failed to register plugin ${r}:`,l),{error:`Failed to register plugin ${r}: ${l instanceof Error?l.message:String(l)}`}}}unregisterPlugin(r){return this.plugins.has(r)?(this.plugins.delete(r),this.pluginHandlers.delete(r),console.log(`Worker unregistered plugin: ${r}`),{status:"success"}):{error:`Plugin ${r} not registered`}}isPluginRegistered(r){return this.plugins.has(r)}getPluginInfo(r){const t=this.plugins.get(r);return t?{id:t.id}:null}getAllPlugins(){return Array.from(this.plugins.values()).map(r=>({id:r.id}))}async callPlugin(r,t,l){const s=this.pluginHandlers.get(r);if(!s)return{error:`Plugin ${r} not registered`};try{const n=await s(t,l);return n instanceof ReadableStream?W(n,[n]):n}catch(n){return console.error(`Error calling plugin ${r}.${t}:`,n),{error:`Error in ${r}.${t}: ${n instanceof Error?n.message:String(n)}`}}}}const q=new Y;S(q)})();
